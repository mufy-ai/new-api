name: 远程服务器部署

on:
  workflow_dispatch:  # 手动触发
  push:
    branches: [ prod ]  # 当推送到prod分支时触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v3
      
      - name: 连接服务器并执行部署
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PWD }}
          port: 22
          script: |
            cd /www/wwwroot/chatmindai/go-server/new-api
            bash deploy.sh
            
      - name: 发送飞书通知
        id: lark_notification
        uses: foxundermoon/feishu-action@v2
        with:
          url: https://open.larksuite.com/open-apis/bot/v2/hook/d52de161-c9fa-443f-a075-c7d233f101e6
          msg_type: text
          content: |
            ✅ 应用已成功部署到服务器！
            📝 提交信息: ${{ github.event.head_commit.message }}
            🔄 触发分支: ${{ github.ref_name }}
            👨‍💻 提交者: ${{ github.actor }} 