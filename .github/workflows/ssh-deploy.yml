name: è¿œç¨‹æœåŠ¡å™¨éƒ¨ç½²

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ prod ]  # å½“æ¨é€åˆ°prodåˆ†æ”¯æ—¶è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ssh-env  # æŒ‡å®šä½¿ç”¨ssh-envç¯å¢ƒå˜é‡
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è¿æ¥æœåŠ¡å™¨å¹¶æ‰§è¡Œéƒ¨ç½²
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PWD }}
          port: 22
          script: sudo -i && cd /www/wwwroot/chatmindai/go-server/new-api && bash scripts/deploy.sh
            
      - name: å‘é€é£ä¹¦é€šçŸ¥
        id: lark_notification
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "âœ… åº”ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼\nğŸ“ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}\nğŸ”„ è§¦å‘åˆ†æ”¯: ${{ github.ref_name }}\nğŸ‘¨â€ğŸ’» æäº¤è€…: ${{ github.actor }}"
              }
            }' \
            https://open.larksuite.com/open-apis/bot/v2/hook/d52de161-c9fa-443f-a075-c7d233f101e6 